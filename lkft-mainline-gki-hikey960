#!/bin/bash

. $(dirname $0)/functions

PATCHES=0
if [ -n "$1" ]; then
        AOSP="$1"
else
        AOSP="`pwd`"
fi

if ! [ -d "$AOSP" ] && ! [ -d "$AOSP/bionic" ] && [ -d "$AOSP"/build ]; then
        echo "This script must be run from the AOSP source directory"
        echo "or with the AOSP source directory as its first parameter."
        exit 1
fi

function apply_jstultz_mainline_patch(){
    local commit_id=$1 && shift
    local local_dir=$1 && shift
    curl_am https://git.linaro.org/people/john.stultz/android-dev.git/patch/?id=${commit_id} ${local_dir}
}

##################################################
################ Linaro hack   ###################
##################################################
## gki: add hikey960_gki.fragment and udpate gki_defconfig for hikey960 [NEW]
## http://android-review.linaro.org/c/kernel/common/+/20887
apply --linaro --local common --remote kernel/common 20887/1
apply --linaro --local kernel/common/mainline --remote kernel/common 20887/1

## Workaround to display homescreen on hdmi monitor
## Revert "ANDROID: staging: ion: add support for consistent heap ids"
## http://android-review.linaro.org/c/kernel/common/+/20882
## https://android-review.googlesource.com/c/kernel/common/+/1108639
apply --linaro --local common --remote kernel/common 20882/1

## Changes on DRM for hikey960 with android-mainline
# drm: kirin: Introduce kirin960
# https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/gpu/drm?h=dev/hikey960-mainline-WIP&id=9cb92a86151c6085a8f2d8f720471795fc0e13c0
apply_jstultz_mainline_patch 9cb92a86151c6085a8f2d8f720471795fc0e13c0 common
# drm: kirin: Add kirin960 dpe driver support
# https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/gpu/drm?h=dev/hikey960-mainline-WIP&id=1edf9816f379bacc19da60fbbb0c954eb15a539c
apply_jstultz_mainline_patch 1edf9816f379bacc19da60fbbb0c954eb15a539c common
# drm: kirin: Remove LDI enable
# https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/gpu/drm?h=dev/hikey960-mainline-WIP&id=fecebab09cdb06add9a1a428d43f71ecedce3020
apply_jstultz_mainline_patch fecebab09cdb06add9a1a428d43f71ecedce3020 common
# drm: kirin: remove wait for VACTIVE IRQ
# https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/gpu/drm?h=dev/hikey960-mainline-WIP&id=0e55d4060fd1ae8a0f442975db857e04f02a624c
apply_jstultz_mainline_patch 0e55d4060fd1ae8a0f442975db857e04f02a624c common
# drm: kirin_drm_dpe: Fix rdma_stride calculation
# https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/gpu/drm?h=dev/hikey960-mainline-WIP&id=e936bdd50a22c21c73a224ef10e2b4de1f7288d7
apply_jstultz_mainline_patch e936bdd50a22c21c73a224ef10e2b4de1f7288d7 common
# drm: kirin960: Remove one mode-line that seems to be causing trouble
# https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/gpu/drm?h=dev/hikey960-mainline-WIP&id=eadfb09b70c7c7c0a2b61cf0a109a822abfa77c3
apply_jstultz_mainline_patch eadfb09b70c7c7c0a2b61cf0a109a822abfa77c3 common
# drm: kirin960: Fix issue seen with HDMI hotplug
# https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/gpu/drm?h=dev/hikey960-mainline-WIP&id=e094474c58ce512d150127a4f5f0740ccf6783bc
apply_jstultz_mainline_patch e094474c58ce512d150127a4f5f0740ccf6783bc common
# drm: kirin: Fix Makefile to correct for module builds
# https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/gpu/drm?h=dev/hikey960-mainline-WIP&id=f0dfa639697278b247251c1d63a2e2ec53307bba
apply_jstultz_mainline_patch f0dfa639697278b247251c1d63a2e2ec53307bba common
# kirin_dpe build fix (fold down)
# https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/gpu/drm?h=dev/hikey960-mainline-WIP&id=cdea042f94fddf97f015565adb7a99746502333b
apply_jstultz_mainline_patch cdea042f94fddf97f015565adb7a99746502333b common

#!/bin/bash

. $(dirname $0)/functions

PATCHES=0
if [ -n "$1" ]; then
        AOSP="$1"
else
        AOSP="`pwd`"
fi

if ! [ -d "$AOSP" ] && ! [ -d "$AOSP/bionic" ] && [ -d "$AOSP"/build ]; then
        echo "This script must be run from the AOSP source directory"
        echo "or with the AOSP source directory as its first parameter."
        exit 1
fi

function apply_jstultz_mainline_patch(){
    local commit_id=$1 && shift
    curl_am https://git.linaro.org/people/john.stultz/android-dev.git/patch/?id=${commit_id} kernel/common/mainline
}

##################################################
################ Linaro hack   ###################
##################################################
## enable overlay manager to boot
## http://android-review.linaro.org/c/kernel/common/+/20511
apply --linaro --local kernel/common/mainline --remote kernel/common 20511/4

########## HiKey960 #################
## hikey960_defconfig: Initial hikey960_defconfig
## https://git.linaro.org/people/john.stultz/android-dev.git/patch/?id=bb81f12f62b651dda3ad11f89610c32aac3b3915
apply_jstultz_mainline_patch bb81f12f62b651dda3ad11f89610c32aac3b3915

## 	dts: hi3660: Add support for usb on Hikey960
## https://git.linaro.org/people/john.stultz/android-dev.git/patch/?id=7fc9d6a6b447f0fdaeca3d9137efb04c85709f9a
apply_jstultz_mainline_patch 7fc9d6a6b447f0fdaeca3d9137efb04c85709f9a

## HACK: dts: hikey960: Add Android Treble dts fstab entry
## https://git.linaro.org/people/john.stultz/android-dev.git/patch/?id=c13f8d73fa4544f4ef411a093de284c5417bfcef
apply_jstultz_mainline_patch c13f8d73fa4544f4ef411a093de284c5417bfcef

## arm64: dts: hikey960: Add CMA entry for ION/framebuffers
## https://git.linaro.org/people/john.stultz/android-dev.git/patch/arch/arm64/boot/dts/hisilicon?id=8a724f92d6dc6456c491dca44532a2fa11a6dc06
apply_jstultz_mainline_patch 8a724f92d6dc6456c491dca44532a2fa11a6dc06

## arm64: dts: hi3660: add display driver dts
## https://git.linaro.org/people/john.stultz/android-dev.git/patch/arch/arm64/boot/dts/hisilicon?id=99a72b871bc77cdc6696b680421c5fb0cd33fc5d
apply_jstultz_mainline_patch 99a72b871bc77cdc6696b680421c5fb0cd33fc5d

## arm64: dts: hi3660: fix adv7533 interrupt
## https://git.linaro.org/people/john.stultz/android-dev.git/patch/arch/arm64/boot/dts/hisilicon?id=db8f2e7ae738e260249b9f3f213967041678bcfd
apply_jstultz_mainline_patch db8f2e7ae738e260249b9f3f213967041678bcfd

## arm64: dts: hi3660-hikey960: Add i2s & sound device
## https://git.linaro.org/people/john.stultz/android-dev.git/patch/arch/arm64/boot/dts/hisilicon?id=8f7531c0c6d5524288aab351679f064a6ddaa73a
apply_jstultz_mainline_patch 8f7531c0c6d5524288aab351679f064a6ddaa73a

## arm64: dts: enable gpu
## https://git.linaro.org/people/john.stultz/android-dev.git/patch/arch/arm64/boot/dts/hisilicon?id=654ca0c7c25c40151471e23c0d48e2485d475560
apply_jstultz_mainline_patch 654ca0c7c25c40151471e23c0d48e2485d475560

## Add "hisilicon,hi3660-reboot" node for hi3660.
## https://git.linaro.org/people/john.stultz/android-dev.git/patch/arch/arm64/boot/dts/hisilicon?id=3ea2d514af5457787ee1c5d9bf7b1ca316ec493b
apply_jstultz_mainline_patch 3ea2d514af5457787ee1c5d9bf7b1ca316ec493b


## dts: hikey960: Fix bootwarning on mapping reboot reason syscon
## https://git.linaro.org/people/john.stultz/android-dev.git/patch/arch/arm64/boot/dts/hisilicon?id=4d3ed3467a0355cf1debe087480ea6c97af713c7
apply_jstultz_mainline_patch 4d3ed3467a0355cf1debe087480ea6c97af713c7

## HACK: arm64/hikey960: remove CPU0's C-states
## https://git.linaro.org/people/john.stultz/android-dev.git/patch/arch/arm64/boot/dts/hisilicon?id=2540ff0f102acbbde084853fceb88a95feb21317
apply_jstultz_mainline_patch 2540ff0f102acbbde084853fceb88a95feb21317

## sound: Add hikey960 i2s audio driver
## https://git.linaro.org/people/john.stultz/android-dev.git/patch/sound/soc/hisilicon?id=3e30a5a82596d1fc15f678bcc62f1f52514ee828
apply_jstultz_mainline_patch 3e30a5a82596d1fc15f678bcc62f1f52514ee828

## HACK: staging: ion: Rework ion_map_dma_buf() to minimize re-mapping
## https://git.linaro.org/people/john.stultz/android-dev.git/patch/drivers/staging/android/ion?id=58db89906efd284d5380e839bd56eb5ead4b851e
apply_jstultz_mainline_patch 58db89906efd284d5380e839bd56eb5ead4b851e

##### usb related changes ###########################################
## usb: roles: Introduce stubs for the exiting functions in role.h.
## https://git.linaro.org/people/john.stultz/android-dev.git/commit/?h=dev/hikey960-mainline-WIP&id=6b417d6cc5b2bba6bfae421b6fc5e7ffc726b681
apply_jstultz_mainline_patch 6b417d6cc5b2bba6bfae421b6fc5e7ffc726b681

## usb: roles: Add usb role switch notifier.
## https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/usb/roles/class.c?h=dev/hikey960-mainline-WIP&id=b0612cfed0d28ea4f2811c793698a749e5be87d8
apply_jstultz_mainline_patch b0612cfed0d28ea4f2811c793698a749e5be87d8

## hikey960: Support usb functionality of Hikey960
## https://git.linaro.org/people/john.stultz/android-dev.git/patch/drivers/misc/hisi_hikey_usb.c?id=87bac5dfb1be7dce66cb50be662c7045a388ad3e
## http://android-review.linaro.org/c/kernel/common/+/20509
apply --linaro --local kernel/common/mainline --remote kernel/common 20509/1

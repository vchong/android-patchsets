#!/bin/bash

. $(dirname $0)/functions

PATCHES=0
if [ -n "$1" ]; then
        AOSP="$1"
else
        AOSP="`pwd`"
fi

if ! [ -d "$AOSP" ] && ! [ -d "$AOSP/bionic" ] && [ -d "$AOSP"/build ]; then
        echo "This script must be run from the AOSP source directory"
        echo "or with the AOSP source directory as its first parameter."
        exit 1
fi

function apply_jstultz_mainline_patch(){
    local commit_id=$1 && shift
    local dst_dir="kernel/common/mainline"
    if [ -n "$1" ]; then
        dst_dir="$1"
    fi

    if [ -d "${dst_dir}" ]; then
        curl_am https://git.linaro.org/people/john.stultz/android-dev.git/patch/?id=${commit_id} "${dst_dir}"
    else
        echo "${dst_dir} does not exist, skip to apply commit:${commit_id}"
    fi
}

function apply_android_review_mainline_patch(){
    local commit_id=$1 && shift
    local dst_dir="kernel/common/mainline"
    if [ -n "$1" ]; then
        dst_dir="$1"
    fi

    if [ -d "${dst_dir}" ]; then
        curl_am https://android-git.linaro.org/kernel/common.git/patch/?id=${commit_id} "${dst_dir}"
    else
        echo "${dst_dir} does not exist, skip to apply commit:${commit_id}"
    fi
}
##################################################
################ Linaro hack   ###################
##################################################
## gki: add hikey960_gki.fragment and udpate gki_defconfig for hikey960 [NEW]
## http://android-review.linaro.org/c/kernel/common/+/20887
apply --linaro --local kernel/common/mainline --remote kernel/common 20887/12

## DTS/hikey960_defconfig for hikey960 for android-mainline
## dts: hi3660: Add support for usb on Hikey960
## https://git.linaro.org/people/john.stultz/android-dev.git/commit/arch/arm64/boot/dts/hisilicon?h=dev/hikey960-mainline-WIP&id=488603ce31ef5b954dc75ba9d65169191b889d8a
apply_jstultz_mainline_patch 488603ce31ef5b954dc75ba9d65169191b889d8a
## arm64: dts: hikey960: Add CMA entry for ION/framebuffers
## https://git.linaro.org/people/john.stultz/android-dev.git/commit/arch/arm64/boot/dts/hisilicon?h=dev/hikey960-mainline-WIP&id=2242887e0725cea23b37e56f6fc60dc99581ab03
apply_jstultz_mainline_patch 2242887e0725cea23b37e56f6fc60dc99581ab03
## arm64: dts: hi3660: add display driver dts
## https://git.linaro.org/people/john.stultz/android-dev.git/commit/arch/arm64/boot/dts/hisilicon?h=dev/hikey960-mainline-WIP&id=08f947950111318d951ea19aa82e605c94ec422f
apply_jstultz_mainline_patch 08f947950111318d951ea19aa82e605c94ec422f
## arm64: dts: hi3660-hikey960: Add i2s & sound device
## https://git.linaro.org/people/john.stultz/android-dev.git/commit/arch/arm64/boot/dts/hisilicon?h=dev/hikey960-mainline-WIP&id=5ecf133e3b5380eafc59f3f1be0ae1b4fcd3030e
apply_jstultz_mainline_patch 5ecf133e3b5380eafc59f3f1be0ae1b4fcd3030e
## arm64: dts: enable gpu
## https://git.linaro.org/people/john.stultz/android-dev.git/commit/arch/arm64/boot/dts/hisilicon?h=dev/hikey960-mainline-WIP&id=886dd0cd39247f741d1b61b9d37c610a076ba3c6
apply_jstultz_mainline_patch 886dd0cd39247f741d1b61b9d37c610a076ba3c6
## arm64: dts: hi3660: adb reboot node
## https://git.linaro.org/people/john.stultz/android-dev.git/commit/arch/arm64/boot/dts/hisilicon?h=dev/hikey960-mainline-WIP&id=cd38cf4abd4881092be3f241f28ded2cbe77c2eb
apply_jstultz_mainline_patch cd38cf4abd4881092be3f241f28ded2cbe77c2eb
## dts: hikey960: Fix bootwarning on mapping reboot reason syscon
## https://git.linaro.org/people/john.stultz/android-dev.git/commit/arch/arm64/boot/dts/hisilicon?h=dev/hikey960-mainline-WIP&id=6cc2375c20a80584b0f9da108ba61970802f65b9
apply_jstultz_mainline_patch 6cc2375c20a80584b0f9da108ba61970802f65b9


## Changes on DRM for hikey960 with android-mainline
# drm: kirin: Introduce kirin960
# https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/gpu/drm?h=dev/hikey960-mainline-WIP&id=8ea426082fda8afbc5fd3dde08d149e8d1ba70c7
apply_jstultz_mainline_patch 8ea426082fda8afbc5fd3dde08d149e8d1ba70c7
# ANDROID: drm: kirin: fix export symbol type
# https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/gpu/drm?h=dev/hikey960-mainline-WIP&id=312b23980205334664ec129f171c2ce0957f6ddf
apply_jstultz_mainline_patch 312b23980205334664ec129f171c2ce0957f6ddf
# drm: kirin: Add kirin960 dpe driver support
# https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/gpu/drm?h=dev/hikey960-mainline-WIP&id=85a6915247219c19ba6122e117b04abcd9aae512
apply_jstultz_mainline_patch 85a6915247219c19ba6122e117b04abcd9aae512
# drm: kirin: remove wait for VACTIVE IRQ
# https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/gpu/drm?h=dev/hikey960-mainline-WIP&id=741d0e8d560994b4da1bbb71f35c22af2a00f728
apply_jstultz_mainline_patch 741d0e8d560994b4da1bbb71f35c22af2a00f728
# drm: kirin_drm_dpe: Fix rdma_stride calculation
# https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/gpu/drm?h=dev/hikey960-mainline-WIP&id=9315b641681672130bc563850f4a5f2e33bcdde4
apply_jstultz_mainline_patch 9315b641681672130bc563850f4a5f2e33bcdde4
# drm: kirin960: Remove one mode-line that seems to be causing trouble
# https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/gpu/drm?h=dev/hikey960-mainline-WIP&id=26def1d7330bdb4f8c23c0e12dd355bfb4228ab6
apply_jstultz_mainline_patch 26def1d7330bdb4f8c23c0e12dd355bfb4228ab6
## HACK: adv7511: Add poweron delay to allow for EDID probing to work
## https://git.linaro.org/people/john.stultz/android-dev.git/commit/?h=dev/hikey960-mainline-WIP&id=33c13fd88156e07b94b1f71a2329408e759fbe7b
apply_jstultz_mainline_patch 33c13fd88156e07b94b1f71a2329408e759fbe7b

## Mali Source for HiKey960 for android-mainline
## https://android-review.linaro.org/c/kernel/common/+/20670
apply --linaro --local kernel/common/mainline --remote kernel/common 20670/9

## misc: hisi_hikey_usb: Driver to support onboard USB gpio hub on Hikey960
## https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/misc/hisi_hikey_usb.c?h=dev/hikey960-mainline-WIP&id=33bdae00879e78e13897cd50eab92600f2fc737d
## http://android-review.linaro.org/c/kernel/common/+/21381
apply --linaro --local kernel/common/mainline --remote kernel/common 21381/1
## reset: hisi-reboot: adb reboot bootloader
## https://git.linaro.org/people/john.stultz/android-dev.git/commit/drivers/power/reset?h=dev/hikey960-mainline-WIP&id=fe671288fa7ad845e525149d6e4686b692926ff8
apply_jstultz_mainline_patch fe671288fa7ad845e525149d6e4686b692926ff8

## sound: Add hikey960 i2s audio driver
## https://android-git.linaro.org/kernel/common.git/patch/?id=2d6e446fde0abe2ee1425f745a23e5f2b3ad1736
apply_android_review_mainline_patch 2d6e446fde0abe2ee1425f745a23e5f2b3ad1736

## fix: bluetooth: hci_ll: set enable_gpio direction OUT at probe
## https://android-git.linaro.org/kernel/common.git/commit/?h=android-mainline-gki-hikey960&id=01f917927efca505bb8e31901a89ee2fa71d73e7
apply_android_review_mainline_patch 01f917927efca505bb8e31901a89ee2fa71d73e7

######### temporary workarounds for sdcardfs ##################
## ANDROID: vfs: Add setattr2 for filesystems with per mount permissions
apply --linaro --local kernel/common/mainline --remote kernel/common 21553/2
## ANDROID: vfs: Add permission2 for filesystems with per mount permissions
apply --linaro --local kernel/common/mainline --remote kernel/common 21554/4
## ANDROID: vfs: add d_canonical_path for stacked filesystem support
apply --linaro --local kernel/common/mainline --remote kernel/common 21555/1
## ANDROID: fs: Restore vfs_path_lookup() export
apply --linaro --local kernel/common/mainline --remote kernel/common 21556/1
## ANDROID: sdcardfs: remove sdcardfs from system
apply --linaro --local kernel/common/mainline --remote kernel/common 21557/1
## ANDROID: fscrypt: add key removal notifier chain
apply --linaro --local kernel/common/mainline --remote kernel/common 21612/1
